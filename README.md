# 股票關係多維度分析實現文檔

## 數據概述與觀察

### 原始數據特點

從 `output` 資料夾中的數據可以觀察到以下特點：

1. **時間維度豐富**：數據涵蓋了從2013年至2024年的多個時間點，每年有多個時間切片（通常為1月、4月、5月、8月、11月）。

2. **數據結構特點**：
   - 每個 CSV 文件代表一個時間點的股票關係矩陣
   - 矩陣大小為 75x75，表示75支股票之間的相互關係
   - 數值分佈集中：大多數相關性數值集中在 0.033~0.034 範圍內，差異極小
   - 呈現對稱性：股票A對B的關係與股票B對A的關係相同

3. **數據挑戰**：
   - 數據差異微小，難以直觀區分重要關聯
   - 數據量大，完整展示75x75矩陣具有挑戰性
   - 時間序列變化微妙，需要特殊處理才能觀察到趨勢

## 設計理念與數據轉化

### 概念設計

基於對數據的觀察，我們設計了三個互補的視覺化維度：

1. **相關性熱圖**：以二維熱圖直觀展示所有股票間的關聯強度，突出核心關聯模式。

2. **時間序列變化**：展示單一股票與其最相關股票間的關聯度如何隨時間變化，捕捉市場結構動態演變。

3. **關聯排行榜**：以表格形式呈現最具關聯性的股票，並按產業分類，提供詳細分析視角。

### 數據轉化策略

為了有效處理原始數據的特點，我們採取了以下策略：

1. **閾值過濾**：
   - 設置閾值機制，只顯示高於某個閾值的相關性數據
   - 閾值設在 0.0330~0.0345 之間，可動態調整以控制信息密度

2. **非線性色階映射**：
   - 根據數據特性設計色階映射，將微小差異放大顯示
   - 提供多種色階方案，適應不同分析需求

3. **行業分組**：
   - 根據股票所屬產業進行分組，突顯產業內部與跨產業關聯
   - 提供產業篩選功能，聚焦分析特定產業內的股票關聯

4. **時間序列非零值聚焦**：
   - 設計「只看非零值變化」模式，專注於有意義的時間點
   - 自動調整Y軸範圍，突顯微小數值變化

## 實現細節

### 相關性熱圖

針對GAT模型生成的相關性數據，我們做了以下特殊處理：

1. **視覺設計**：
   - 將統計上顯著的相關性數值（>0.033）映射為色彩強度
   - 確保格子為正方形，便於直觀比較不同位置的色彩強度
   - 提供多種色階（綠、藍、紅、紫等），滿足不同分析偏好

2. **交互功能**：
   - 可縮放和平移，聚焦任意區域
   - 產業標籤過濾功能，專注於單一產業內部關聯
   - 懸停提示詳細資訊，包括精確相關度數值

3. **數據優化**：
   - 閾值選擇器（0.0330-0.0345），平衡信息量與可讀性
   - 動態計算統計信息（均值、標準差）以提供數據背景
   - 適應性色階範圍計算，根據數據分佈自動優化色彩對比

### 時間序列變化圖

為了展示特定股票與其相關股票的關聯度如何隨時間變化：

1. **數據處理**：
   - 獲取指定日期下與目標股票關聯度最高的5支股票
   - 在過去10個時間點中追蹤它們的關聯度變化
   - 處理缺失值和零值，確保視覺連續性

2. **設計優化**：
   - 「只看非零值變化」模式，自動調整Y軸範圍專注於有意義的變化
   - 非零值使用大尺寸實心點，零值使用小點或隱藏
   - 連接所有數據點，提供趨勢連續性

3. **互動功能**：
   - X軸時間縮放，聚焦特定時期
   - 多股票同時比較，直觀觀察關聯度變化差異
   - 詳細的懸停提示，顯示精確數值

### 關聯排行榜與產業分析

將數據結構化為更易理解的表格形式：

1. **數據轉化**：
   - 將矩陣數據轉為排序表格，突顯最相關股票
   - 計算每支股票在產業內的排名和百分比
   - 統計產業級別的關聯性分布

2. **分析功能**：
   - 多維度排序（相關度、產業內排名等）
   - 產業過濾，專注於特定產業關聯
   - 產業覆蓋率計算，了解股票在產業中的代表性

3. **視覺設計**：
   - 產業標籤色彩編碼，視覺上區分不同產業
   - 階層化信息展示，從個股到產業統計
   - 互動式表格，支持多維度探索

## 技術實現與數據流

### 數據流程

1. **後端數據源**：
   - `output` 資料夾中的CSV文件作為原始數據
   - 透過Flask API提供數據訪問接口：
     - `/gat/dates` 返回可用日期列表
     - `/gat/{date}` 返回指定日期的完整相關性矩陣

2. **前端數據處理**：
   - 按需獲取數據，避免一次加載全部
   - 動態計算統計信息，包括均值、標準差、百分位數等
   - 實施多重數據轉換，將矩陣數據轉為熱圖、時間序列、排行榜等視圖

3. **交互式數據探索**：
   - 股票選擇：切換不同股票作為關注焦點
   - 日期選擇：在不同時間點間切換
   - 產業過濾：專注於特定產業內部關聯
   - 閾值調整：控制數據篩選嚴格程度

### 技術實現關鍵點

1. **動態色階範圍計算**：
   ```javascript
   const getColorRange = (stats) => {
       if (normalizeMethod === 'gat_special') {
           // 分析實際數據發現多數值集中在0.033-0.034之間
           // 使用更精細的範圍劃分來突顯微小差異
           const typicalMin = 0.0337;
           const typicalMax = 0.0339;
           const midPoint = (typicalMin + typicalMax) / 2;
           const range = (typicalMax - typicalMin) / 2;
           const adjustedRange = range / (contrastLevel * 0.5);
           
           return {
               min: typicalMin - adjustedRange,
               max: typicalMax + adjustedRange
           };
       }
       /* 其他映射方法 */
   };
   ```

2. **非零值時間序列處理**：
   ```javascript
   // 在"只看非零值變化"模式下的處理
   const symbolSizes = dates.map(date => {
       const value = stockData[date][relatedStock];
       return value > 0 ? 8 : (showOnlyNonZero ? 0 : 4);
   });
   
   // Y軸範圍動態調整
   let yAxisOption = {};
   if (showOnlyNonZero) {
       const minY = Math.max(0, mean - std * 1.5);
       const maxY = mean + std * 2;
       yAxisOption = { min: minY, max: maxY };
   } else {
       yAxisOption = { min: 0, max: mean + std * 2 };
   }
   ```

3. **產業統計與排名計算**：
   ```javascript
   // 計算每個股票在其產業內的排名和比例
   correlations.forEach(item => {
       item.industryRank = correlations.filter(
           c => c.industry === item.industry && c.correlation > item.correlation
       ).length + 1;
       
       item.industryTotal = correlations.filter(
           c => c.industry === item.industry
       ).length;
       
       item.industryPercentage = (item.industryRank / item.industryTotal * 100).toFixed(1);
   });
   ```

## 效果與意義

通過這種多維度的視覺化分析，我們實現了以下效果：

1. **微小差異的顯著呈現**：
   - 將集中在 0.033~0.034 範圍內的微小差異放大，使模式變得可見
   - 通過色彩映射，將數值差異轉換為視覺差異，更直觀

2. **多維度數據探索**：
   - 從全局熱圖到時間序列再到排行榜，提供完整分析路徑
   - 特定股票、產業和時間點的靈活組合，支持多角度探索

3. **時間序列洞察**：
   - 揭示股票關聯度的動態變化，捕捉市場結構變化
   - 識別關聯度突變點，可能對應重大市場事件

4. **產業關聯分析**：
   - 顯示產業內部和跨產業的關聯模式
   - 幫助發現非直觀的跨產業關聯，潛在投資機會

通過這些分析，我們能夠：

- 優化投資組合，避免高相關性股票的過度配置
- 發現非傳統關聯的股票組合，可能具有相似價格變動模式
- 追蹤關聯結構變化，調整投資策略
- 發現產業內異常關聯模式，可能暗示未被市場察覺的基本面變化

## 結論

基於 GAT 模型生成的數據，我們構建了一個多維度的股票關聯分析系統，將原始的數值矩陣轉換為直觀、互動且信息豐富的視覺化呈現。系統不僅解決了數據呈現的技術挑戰，更提供了全新的市場結構洞察視角，有助於投資決策和市場理解。

特別值得注意的是，我們對這類特殊數據分佈（微小差異）的處理方法，展示了如何通過視覺化技術揭示隱藏在數據中的模式，而這些模式在原始數據中難以直接觀察到。 